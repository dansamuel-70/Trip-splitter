<script>
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAXsCINHxQXYxTcge4Mp9St3XzeG4vZwjE",
  authDomain: "trip-splitter-7d2ee.firebaseapp.com",
  projectId: "trip-splitter-7d2ee",
  storageBucket: "trip-splitter-7d2ee.firebasestorage.app",
  messagingSenderId: "446178975806",
  appId: "1:446178975806:web:9885d00d7f2af5a55d716f",
  measurementId: "G-HS5GQ92RFY"
};
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>

        // =========================================================
        // 2. PASTE YOUR CONFIGURATION HERE
        // =========================================================
        const firebaseConfig = {
            // !!! REPLACE THIS ENTIRE CONFIG OBJECT WITH YOUR REAL KEYS !!!
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // References for the database nodes
        const membersRef = database.ref('members');
        const expensesRef = database.ref('expenses');

        // Local arrays will now be populated by Firebase listeners
        let members = [];
        let expenses = [];
        
        // --- Member Management (UPDATED TO USE FIREBASE) ---
        
        // Setup listener for members
        membersRef.on('value', (snapshot) => {
            members = [];
            snapshot.forEach((childSnapshot) => {
                members.push(childSnapshot.val());
            });
            updateUIElements();
            console.log("Members loaded from Firebase.");
        });

        function addMember() {
            const nameInput = document.getElementById('new-member-name');
            const name = nameInput.value.trim();
            if (name && !members.includes(name)) {
                // WRITE to Firebase
                membersRef.child(name).set(name) 
                nameInput.value = '';
            }
        }
        
        // updateUIElements remains largely the same, but only rebuilds UI
        function updateUIElements() {
            // ... (Your existing updateUIElements code remains here)
            const membersListDiv = document.getElementById('members-list');
            membersListDiv.innerHTML = members.map(m => `<span>${m}</span>`).join('');

            const paidBySelect = document.getElementById('expense-paid-by');
            paidBySelect.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
            
            const splitCheckboxesDiv = document.getElementById('split-among-checkboxes');
            if (members.length > 0) {
                // This clears the innerHTML completely and rebuilds the checklist
                splitCheckboxesDiv.innerHTML = members.map(m => `
                    <label>
                        <input type="checkbox" name="split-member" value="${m}" checked> ${m}
                    </label>
                `).join('');
            } else {
                splitCheckboxesDiv.innerHTML = '<p>Please add members first.</p>';
            }
            updateExpensesList(); 
        }

        // --- Expense Management (UPDATED TO USE FIREBASE) ---

        // Setup listener for expenses
        expensesRef.on('value', (snapshot) => {
            expenses = [];
            // We store the Firebase key along with the expense data for editing
            snapshot.forEach((childSnapshot) => {
                const expense = childSnapshot.val();
                expense.key = childSnapshot.key; 
                expenses.push(expense);
            });
            updateExpensesList();
            console.log("Expenses loaded from Firebase.");
        });
        
        document.getElementById('expense-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const paidBy = document.getElementById('expense-paid-by').value;
            const editKey = document.getElementById('edit-expense-index').value; // Now holds the Firebase key
            
            const splitMembers = Array.from(document.querySelectorAll('input[name="split-member"]:checked'))
                .map(input => input.value);

            if (splitMembers.length === 0) {
                alert('Please select at least one person to split the expense among.');
                return;
            }
            
            const expenseData = {
                description,
                amount,
                paidBy,
                splitMembers
            };
            
            if (editKey !== '') {
                // EDIT MODE: Update existing expense in Firebase
                expensesRef.child(editKey).update(expenseData);
                alert('Expense updated!');
            } else {
                // ADD MODE: Push new expense to Firebase
                expensesRef.push(expenseData);
                alert('Expense added!');
            }

            // Reset form
            document.getElementById('expense-form').reset();
            document.getElementById('edit-expense-index').value = '';
            document.getElementById('submit-expense-button').textContent = 'Add Expense';
            document.querySelectorAll('input[name="split-member"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        });
        
        function updateExpensesList() {
            const expensesListUl = document.getElementById('expenses-list');
            expensesListUl.innerHTML = expenses.map((exp, index) => `
                <li>
                    <strong>${exp.description}: $${exp.amount.toFixed(2)}</strong>
                    <br>
                    Paid by: ${exp.paidBy}. Split among: ${exp.splitMembers.join(', ')}.
                    <span class="expense-actions">
                        <button onclick="editExpense(${index})">Edit</button>
                    </span>
                </li>
            `).join('');
        }

        // --- Edit Functionality (UPDATED TO USE INDEX TO FIND KEY) ---

        function editExpense(index) {
            const expense = expenses[index];
            
            // 1. Fill the hidden index input with the Firebase key
            document.getElementById('edit-expense-index').value = expense.key;

            // 2. Populate form fields
            document.getElementById('expense-description').value = expense.description;
            document.getElementById('expense-amount').value = expense.amount;
            document.getElementById('expense-paid-by').value = expense.paidBy;

            // 3. Update the button text
            document.getElementById('submit-expense-button').textContent = 'Update Expense';

            // 4. Update the split-among checkboxes
            const splitCheckboxesDiv = document.getElementById('split-among-checkboxes');
            splitCheckboxesDiv.innerHTML = members.map(m => {
                const checked = expense.splitMembers.includes(m) ? 'checked' : '';
                return `
                    <label>
                        <input type="checkbox" name="split-member" value="${m}" ${checked}> ${m}
                    </label>
                `;
            }).join('');
            
            document.getElementById('expense-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        // --- Calculation Logic (Still uses local 'expenses' array, which is updated by Firebase) ---
        
        function calculateSettlements() {
            // ... (Your existing calculateSettlements code remains here)
            if (members.length === 0 || expenses.length === 0) {
                document.getElementById('results').innerHTML = '<p>Please add members and expenses first.</p>';
                return;
            }

            // 1. Calculate net balance for each member
            const balances = {};
            members.forEach(m => balances[m] = 0);
            
            expenses.forEach(exp => {
                const amount = exp.amount;
                const paidBy = exp.paidBy;
                const splitMembers = exp.splitMembers;
                const splitAmount = amount / splitMembers.length;

                // Credit the payer (Paid By) with the total amount
                balances[paidBy] += amount;

                // Debit each beneficiary (Split Among) by their share
                splitMembers.forEach(member => {
                    balances[member] -= splitAmount;
                });
            });

            // 2. Prepare Results Display (Summary)
            const summaryHTML = members.map(member => {
                const balance = balances[member];
                const typeClass = balance >= 0 ? 'owed' : 'owes';
                const status = balance >= 0 ? 'is owed' : 'owes';
                const absoluteBalance = Math.abs(balance).toFixed(2);
                
                return `
                    <div class="summary-item ${typeClass}">
                        <strong>${member}</strong> ${status} 
                        <strong>$${absoluteBalance}</strong> overall.
                    </div>
                `;
            }).join('');
            
            // 3. Prepare Settlement Suggestions (Simplification Algorithm)
            let creditors = members.filter(m => balances[m] > 0).sort((a, b) => balances[b] - balances[a]);
            let debtors = members.filter(m => balances[m] < 0).sort((a, b) => balances[a] - balances[b]);
            
            const settlements = [];
            
            while (debtors.length > 0 && creditors.length > 0) {
                const debtor = debtors[0];
                const creditor = creditors[0];

                const amountToPay = Math.min(Math.abs(balances[debtor]), balances[creditor]);
                
                settlements.push({
                    from: debtor,
                    to: creditor,
                    amount: amountToPay
                });

                balances[debtor] += amountToPay;
                balances[creditor] -= amountToPay;

                if (Math.abs(balances[debtor]) < 0.01) {
                    debtors.shift();
                }
                if (Math.abs(balances[creditor]) < 0.01) {
                    creditors.shift();
                }

                creditors.sort((a, b) => balances[b] - balances[a]);
                debtors.sort((a, b) => balances[a] - balances[b]);
            }
            
            const settlementHTML = settlements.map(s => `
                <div class="settlement-item">
                    <strong>${s.from}</strong> pays <strong>$${s.amount.toFixed(2)}</strong> to <strong>${s.to}</strong>
                </div>
            `).join('');


            // 4. Final Display Update
            document.getElementById('results').innerHTML = `
                <h3>Net Balances Summary</h3>
                ${summaryHTML}
                <h3 style="margin-top: 30px;">Recommended Settlements</h3>
                ${settlementHTML || '<p>Everyone is settled up!</p>'}
            `;
        }
        
    </script>