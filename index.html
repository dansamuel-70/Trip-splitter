<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Trip Splitter</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1, h2, h3 { color: #333; }
        .container { border: 1px solid #ddd; padding: 20px; margin-bottom: 30px; border-radius: 8px; }
        #members-list span { display: inline-block; background: #e0f7fa; padding: 5px 10px; margin: 5px; border-radius: 4px; }
        #expense-form label { display: block; margin-top: 10px; font-weight: bold; }
        #expense-form input, #expense-form select { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
        #split-among-checkboxes label { display: inline-block; margin-right: 15px; font-weight: normal; }
        #expenses-list { list-style: none; padding: 0; }
        #expenses-list li { border-bottom: 1px dashed #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .expense-actions button { margin-left: 10px; padding: 5px 10px; cursor: pointer; border: none; border-radius: 4px; }
        .expense-actions button:hover { opacity: 0.8; }
        .expense-actions button:nth-child(1) { /* Edit button */ background-color: #2196F3; color: white; }
        .expense-actions button:nth-child(2) { /* Delete button */ background-color: #f44336; color: white; }
        
        /* Calculation Results Styling */
        .summary-item { padding: 10px; margin-top: 5px; border-radius: 4px; }
        .owed { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .owes { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .settlement-item { padding: 8px; margin-top: 5px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 4px; }

        /* Trip Selector Styling */
        #trip-selector-container, #new-trip-container { display: flex; align-items: center; margin-bottom: 20px; }
        #trip-selector-container label { margin-right: 10px; }
        #new-trip-name { flex-grow: 1; margin-right: 10px; padding: 8px; }
    </style>
</head>
<body>

    <h1>üåé Trip Expense Splitter</h1>
    
    <div class="container">
        <h2>‚úàÔ∏è Select/Create Trip</h2>
        
        <div id="new-trip-container">
            <input type="text" id="new-trip-name" placeholder="Enter new trip name (e.g., Summer Holiday)">
            <button onclick="createTrip()">Create Trip</button>
        </div>

        <div id="trip-selector-container">
            <label for="trip-selector">Active Trip:</label>
            <select id="trip-selector" onchange="changeActiveTrip(this.value)">
                <option value="" disabled selected>-- Select a Trip --</option>
            </select>
        </div>
    </div>

    <div id="app-content" style="opacity: 0.5; pointer-events: none;">
        <div class="container">
            <h2>üë• Manage Members for <span id="current-trip-name">Current Trip</span></h2>
            <div>
                <input type="text" id="new-member-name" placeholder="Enter member name (e.g., Alice)">
                <button onclick="addMember()">Add Member</button>
            </div>

            <h3>Current Members:</h3>
            <div id="members-list">
                <p>No members added yet.</p>
            </div>
        </div>
        
        <div class="container">
            <h2>üí∏ Add/Edit Expense</h2>
            <form id="expense-form">
                <input type="hidden" id="edit-expense-index" value=""> 

                <label for="expense-description">Description:</label>
                <input type="text" id="expense-description" required>

                <label for="expense-amount">Amount ($):</label>
                <input type="number" id="expense-amount" step="0.01" min="0.01" required>

                <label for="expense-paid-by">Paid By:</label>
                <select id="expense-paid-by" required>
                    </select>

                <label>Split Among:</label>
                <div id="split-among-checkboxes">
                    <p>Please add members first.</p>
                </div>
                
                <button type="submit" id="submit-expense-button" style="margin-top: 20px;">Add Expense</button>
            </form>
        </div>

        <div class="container">
            <h2>üßæ Expense History</h2>
            <ul id="expenses-list">
                <p>No expenses recorded yet.</p>
            </ul>
        </div>
        
        <div class="container">
            <h2>üìä Balances & Settlements</h2>
            <button onclick="calculateSettlements()">Calculate Settlements</button>
            
            <div id="results" style="margin-top: 15px;">
                <p>Click 'Calculate Settlements' to see results.</p>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // =========================================================
        // 1. FIREBASE CONFIGURATION
        // ** IMPORTANT: REPLACE THIS ENTIRE OBJECT WITH YOUR REAL KEYS **
        // =========================================================
        const firebaseConfig = {
            // !!! REPLACE THIS ENTIRE CONFIG OBJECT WITH YOUR REAL KEYS !!!
            apiKey: "AIzaSyAXsCINHxQXYxTcge4Mp9St3XzeG4vZwjE",
            authDomain: "trip-splitter-7d2ee.firebaseapp.com",
            databaseURL: "https://trip-splitter-7d2ee-default-rtdb.firebaseio.com",
            projectId: "trip-splitter-7d2ee",
            storageBucket: "trip-splitter-7d2ee.firebasestorage.app",
            messagingSenderId: "446178975806",
            appId: "1:446178975806:web:9885d00d7f2af5a55d716f",
            measurementId: "G-HS5GQ92RFY"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // --- GLOBAL REFERENCES & STATE ---
        const tripsRef = database.ref('trips');
        let activeTripKey = null;
        let allTrips = {}; // {key: {name: '...', expenses: [], members: []}}

        // Local arrays will now be trip-specific
        let members = [];
        let expenses = [];
        
        // --- 0. TRIP MANAGEMENT ---

        // Setup listener for ALL trips
        tripsRef.on('value', (snapshot) => {
            allTrips = {};
            snapshot.forEach((childSnapshot) => {
                const tripData = childSnapshot.val();
                const key = childSnapshot.key;
                allTrips[key] = {
                    key: key,
                    name: tripData.name,
                };
            });
            updateTripSelectorUI();
            
            // If no active trip is selected, try to select the first one
            if (!activeTripKey && Object.keys(allTrips).length > 0) {
                changeActiveTrip(Object.keys(allTrips)[0]);
            }
        });

        function updateTripSelectorUI() {
            const selector = document.getElementById('trip-selector');
            selector.innerHTML = '<option value="" disabled>-- Select a Trip --</option>';

            const sortedTripKeys = Object.keys(allTrips).sort((a, b) => allTrips[a].name.localeCompare(allTrips[b].name));
            
            sortedTripKeys.forEach(key => {
                const trip = allTrips[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = trip.name;
                if (key === activeTripKey) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
        }

        function createTrip() {
            const nameInput = document.getElementById('new-trip-name');
            const name = nameInput.value.trim();
            if (!name) {
                alert("Please enter a name for the new trip.");
                return;
            }

            // Push the new trip data
            tripsRef.push({ name: name, createdAt: firebase.database.ServerValue.TIMESTAMP })
                .then(newTripRef => {
                    nameInput.value = '';
                    changeActiveTrip(newTripRef.key);
                })
                .catch(error => {
                    console.error("Error creating trip:", error);
                });
        }

        // Switches the active trip, and re-attaches Firebase listeners
        function changeActiveTrip(tripKey) {
            activeTripKey = tripKey;
            
            if (tripKey) {
                const tripName = allTrips[tripKey].name;
                document.getElementById('current-trip-name').textContent = tripName;
                document.getElementById('app-content').style.opacity = '1';
                document.getElementById('app-content').style.pointerEvents = 'auto';

                // 1. Setup NEW Members Listener for the new trip
                const membersTripRef = database.ref(`trips/${tripKey}/members`);
                membersTripRef.on('value', handleMembersSnapshot);

                // 2. Setup NEW Expenses Listener for the new trip
                const expensesTripRef = database.ref(`trips/${tripKey}/expenses`);
                expensesTripRef.on('value', handleExpensesSnapshot);

                console.log(`Active Trip switched to: ${tripName}`);
            } else {
                // No trip selected
                document.getElementById('current-trip-name').textContent = 'None Selected';
                document.getElementById('app-content').style.opacity = '0.5';
                document.getElementById('app-content').style.pointerEvents = 'none';
                members = [];
                expenses = [];
                updateUIElements();
            }
        }

        // --- HANDLERS for Firebase Snapshots ---
        
        function handleMembersSnapshot(snapshot) {
            members = [];
            snapshot.forEach((childSnapshot) => {
                members.push(childSnapshot.val());
            });
            updateUIElements();
        }

        function handleExpensesSnapshot(snapshot) {
            expenses = [];
            snapshot.forEach((childSnapshot) => {
                const expense = childSnapshot.val();
                expense.key = childSnapshot.key; 
                expenses.push(expense);
            });
            updateExpensesList();
        }
        
        // --- 1. MEMBER MANAGEMENT ---
        
        function addMember() {
            if (!activeTripKey) return alert("Please select a trip first.");

            const nameInput = document.getElementById('new-member-name');
            const name = nameInput.value.trim();
            
            if (name && !members.includes(name)) {
                const membersTripRef = database.ref(`trips/${activeTripKey}/members`);
                // Use the name as the key for simplicity in the members node
                membersTripRef.child(name).set(name) 
                nameInput.value = '';
            }
        }
        
        function updateUIElements() {
            const membersListDiv = document.getElementById('members-list');
            membersListDiv.innerHTML = members.map(m => `<span>${m}</span>`).join('');

            const paidBySelect = document.getElementById('expense-paid-by');
            paidBySelect.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
            
            const splitCheckboxesDiv = document.getElementById('split-among-checkboxes');
            if (members.length > 0) {
                splitCheckboxesDiv.innerHTML = members.map(m => `
                    <label>
                        <input type="checkbox" name="split-member" value="${m}" checked> ${m}
                    </label>
                `).join('');
            } else {
                splitCheckboxesDiv.innerHTML = '<p>Please add members first.</p>';
            }
            updateExpensesList();
        }

        // --- 2 & 3. EXPENSE MANAGEMENT & LIST ---

        document.getElementById('expense-form').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!activeTripKey) return alert("Please select a trip first.");
            
            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const paidBy = document.getElementById('expense-paid-by').value;
            const editKey = document.getElementById('edit-expense-index').value;
        
            const splitMembers = Array.from(document.querySelectorAll('input[name="split-member"]:checked'))
                .map(input => input.value);

            if (splitMembers.length === 0) {
                alert('Please select at least one person to split the expense among.');
                return;
            }
            
            const expenseData = {
                description,
                amount,
                paidBy,
                splitMembers,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            const expensesTripRef = database.ref(`trips/${activeTripKey}/expenses`);

            if (editKey !== '') {
                // EDIT MODE
                expensesTripRef.child(editKey).update(expenseData);
                alert('Expense updated!');
            } else {
                // ADD MODE
                expensesTripRef.push(expenseData);
                alert('Expense added!');
            }

            // Reset form
            document.getElementById('expense-form').reset();
            document.getElementById('edit-expense-index').value = '';
            document.getElementById('submit-expense-button').textContent = 'Add Expense';
            document.querySelectorAll('input[name="split-member"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        });
        
        function updateExpensesList() {
            const expensesListUl = document.getElementById('expenses-list');
            expensesListUl.innerHTML = expenses.map((exp, index) => `
                <li>
                    <div>
                        <strong>${exp.description}: $${exp.amount.toFixed(2)}</strong>
                        <br>
                        Paid by: ${exp.paidBy}. Split among: ${exp.splitMembers.join(', ')}.
                    </div>
            
                    <span class="expense-actions">
                        <button onclick="editExpense(${index})">Edit</button>
                        <button onclick="deleteExpense(${index})">Delete</button>
                    </span>
                </li>
            `).join('');
        }

        function deleteExpense(index) {
            if (!activeTripKey) return;
            if (confirm(`Are you sure you want to delete the expense: ${expenses[index].description}?`)) {
                const key = expenses[index].key;
                const expensesTripRef = database.ref(`trips/${activeTripKey}/expenses`);

                expensesTripRef.child(key).remove()
                    .then(() => {
                        console.log("Expense deleted successfully.");
                    })
                    .catch((error) => {
                        console.error("Error deleting expense:", error);
                        alert("Failed to delete expense. Check console for details.");
                    });
            }
        }
        
        function editExpense(index) {
            const expense = expenses[index];
            document.getElementById('edit-expense-index').value = expense.key;
            document.getElementById('expense-description').value = expense.description;
            document.getElementById('expense-amount').value = expense.amount;
            document.getElementById('expense-paid-by').value = expense.paidBy;
            document.getElementById('submit-expense-button').textContent = 'Update Expense';

            const splitCheckboxesDiv = document.getElementById('split-among-checkboxes');
            splitCheckboxesDiv.innerHTML = members.map(m => {
                const checked = expense.splitMembers.includes(m) ? 'checked' : '';
                return `
                    <label>
                        <input type="checkbox" name="split-member" value="${m}" ${checked}> ${m}
                    </label>
                `;
            }).join('');
            document.getElementById('expense-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        // --- 4. CALCULATION LOGIC ---
        
        function calculateSettlements() {
            if (!activeTripKey) return alert("Please select a trip first.");

            if (members.length === 0 || expenses.length === 0) {
                document.getElementById('results').innerHTML = '<p>Please add members and expenses first.</p>';
                return;
            }

            // 1. Calculate net balance for each member
            const balances = {};
            members.forEach(m => balances[m] = 0);
            
            expenses.forEach(exp => {
                const amount = exp.amount;
                const paidBy = exp.paidBy;
                const splitMembers = exp.splitMembers;
                const splitAmount = amount / splitMembers.length;

                balances[paidBy] += amount;

                splitMembers.forEach(member => {
                    balances[member] -= splitAmount;
                });
            });

            // 2. Prepare Results Display (Summary)
            const summaryHTML = members.map(member => {
                const balance = balances[member];
                const typeClass = balance >= 0 ? 'owed' : 'owes';
                const status = balance >= 0 ? 'is owed' : 'owes';
                const absoluteBalance = Math.abs(balance).toFixed(2);
                
                return `
                    <div class="summary-item ${typeClass}">
                        <strong>${member}</strong> ${status} 
                        <strong>$${absoluteBalance}</strong> overall.
                    </div>
                `;
            }).join('');
            
            // 3. Prepare Settlement Suggestions (Simplification Algorithm)
            let creditors = members.filter(m => balances[m] > 0).sort((a, b) => balances[b] - balances[a]);
            let debtors = members.filter(m => balances[m] < 0).sort((a, b) => balances[a] - balances[b]);
            
            const settlements = [];
            while (debtors.length > 0 && creditors.length > 0) {
                const debtor = debtors[0];
                const creditor = creditors[0];

                const amountToPay = Math.min(Math.abs(balances[debtor]), balances[creditor]);
                
                settlements.push({
                    from: debtor,
                    to: creditor,
                    amount: amountToPay
                });
                balances[debtor] += amountToPay;
                balances[creditor] -= amountToPay;

                if (Math.abs(balances[debtor]) < 0.01) {
                    debtors.shift();
                }
                if (Math.abs(balances[creditor]) < 0.01) {
                    creditors.shift();
                }

                creditors.sort((a, b) => balances[b] - balances[a]);
                debtors.sort((a, b) => balances[a] - balances[b]);
            }
            
            const settlementHTML = settlements.map(s => `
                <div class="settlement-item">
                    <strong>${s.from}</strong> pays <strong>$${s.amount.toFixed(2)}</strong> to <strong>${s.to}</strong>
                </div>
            `).join('');

            // 4. Final Display Update
            document.getElementById('results').innerHTML = `
                <h3>Net Balances Summary</h3>
                ${summaryHTML}
                <h3 style="margin-top: 30px;">Recommended Settlements</h3>
                ${settlementHTML || '<p>Everyone is settled up!</p>'}
            `;
        }
    </script>

</body>
</html>